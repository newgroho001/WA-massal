<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirim WA Massal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h2>Kirim WA Massal dari XLSX</h2>
    <input type="file" id="fileInput" accept=".xlsx">
    <br><br>
    <textarea id="pesanTemplate" rows="4" cols="50" placeholder="Tulis pesan di sini, gunakan {nama} untuk personalisasi...">
Halo {nama}, ini adalah pesan otomatis untuk Anda. Semoga harimu menyenangkan!
    </textarea>
    <br><br>
    <button onclick="prosesFile()">Proses File & Kirim WA</button>
    <p id="status"></p>

    <script>
        function prosesFile() {
            let file = document.getElementById("fileInput").files[0];
            if (!file) {
                alert("Pilih file XLSX terlebih dahulu!");
                return;
            }

            let reader = new FileReader();
            reader.onload = function (e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, { type: "array" });
                let sheet = workbook.Sheets[workbook.SheetNames[0]];
                let jsonData = XLSX.utils.sheet_to_json(sheet);

                let pesanTemplate = document.getElementById("pesanTemplate").value;
                let statusText = document.getElementById("status");

                let totalPesan = jsonData.length;
                let index = 0;

                function kirimPesan() {
                    if (index >= totalPesan) {
                        statusText.innerHTML = "âœ… Semua pesan telah dikirim!";
                        return;
                    }

                    let row = jsonData[index];
                    let nomor = row["Nomor"] ? row["Nomor"].toString().replace(/\D/g, "") : "";
                    let nama = row["Nama"] || "Pelanggan";

                    if (!nomor.startsWith("62")) {
                        nomor = "62" + nomor.substring(1);
                    }

                    let pesan = pesanTemplate.replace("{nama}", nama);
                    let encodedMessage = encodeURIComponent(pesan);
                    let waUrl = `https://wa.me/${nomor}?text=${encodedMessage}`;

                    let waWindow = window.open(waUrl, "_blank");

                    statusText.innerHTML = `ðŸ“© Mengirim ke: ${nama} (${nomor}) - ${index + 1} dari ${totalPesan}`;

                    setTimeout(() => {
                        waWindow.close();
                        index++;
                        kirimPesan();
                    }, 5000); // Jeda 5 detik sebelum melanjutkan
                }

                kirimPesan();
            };

            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
